// src/lib/deepseek-service.ts
// Exporter le type depuis le service aussi pour coh√©rence
export interface ChatMessage {
    role: 'user' | 'assistant' | 'system';
    content: string;
  }
  
  export class DeepSeekService {
    private apiKey: string;
    private baseURL: string = 'https://api.deepseek.com/v1';
  
    constructor() {
      const apiKey = process.env.DEEPSEEK_API_KEY;
      if (!apiKey) {
        throw new Error('DEEPSEEK_API_KEY is required');
      }
      this.apiKey = apiKey;
    }
  
    async chat(messages: ChatMessage[]): Promise<string> {
      try {
        console.log('ü§ñ Sending request to DeepSeek API...');
        
        const response = await fetch(`${this.baseURL}/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.apiKey}`
          },
          body: JSON.stringify({
            model: 'deepseek-chat',
            messages: messages,
            temperature: 0.7,
            max_tokens: 2000,
            stream: false
          })
        });
  
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`DeepSeek API error: ${response.status} - ${errorText}`);
        }
  
        const data = await response.json();
        
        if (!data.choices?.[0]?.message?.content) {
          throw new Error('Invalid response format from DeepSeek API');
        }
  
        console.log('‚úÖ Received response from DeepSeek');
        return data.choices[0].message.content;
  
      } catch (error) {
        console.error('‚ùå DeepSeek API error:', error);
        throw error;
      }
    }
  
    // M√©thodes utilitaires pour des cas d'usage sp√©cifiques
    async explainConcept(concept: string, gradeLevel: string = '6√®me'): Promise<string> {
      return this.chat([
        {
          role: 'system',
          content: `Tu es un professeur de coll√®ge sp√©cialis√© pour les √©l√®ves de ${gradeLevel}. Sois clair, p√©dagogique et utilise des exemples concrets.`
        },
        {
          role: 'user',
          content: `Explique-moi le concept suivant de mani√®re simple: ${concept}`
        }
      ]);
    }
  
    async helpWithHomework(subject: string, question: string): Promise<string> {
      return this.chat([
        {
          role: 'system',
          content: `Tu es un assistant p√©dagogique. Aide l'√©l√®ve √† comprendre sans donner la r√©ponse directement. Pose des questions pour le guider.`
        },
        {
          role: 'user',
          content: `Sujet: ${subject}\nQuestion: ${question}`
        }
      ]);
    }
  
    async generateExercise(topic: string, difficulty: 'easy' | 'medium' | 'hard' = 'medium'): Promise<string> {
      return this.chat([
        {
          role: 'system',
          content: `Tu es un professeur cr√©ant des exercices. Cr√©e un exercice adapt√© au niveau de difficult√©.`
        },
        {
          role: 'user',
          content: `Cr√©e un exercice sur le th√®me "${topic}" avec un niveau de difficult√© ${difficulty}`
        }
      ]);
    }
  }
  
  // Instance singleton
  let deepSeekInstance: DeepSeekService | null = null;
  
  export function getDeepSeekService(): DeepSeekService {
    if (!deepSeekInstance) {
      deepSeekInstance = new DeepSeekService();
    }
    return deepSeekInstance;
  }