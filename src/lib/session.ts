// src/lib/session.ts
import { headers } from 'next/headers';
import { Role } from "./types";
import { allDummyStudents } from "./dummy-data"; // Importer les donn√©es

// ---=== BYPASS BACKEND - LOGIQUE DE SESSION FACTICE ===---
// Cette fonction simule la r√©cup√©ration d'une session pour le d√©veloppement
// sans n√©cessiter une v√©ritable authentification. Elle se base sur un cookie.

export type DummySession = {
    user?: {
        id: string;
        name?: string | null;
        email?: string | null;
        image?: string | null;
        role?: Role;
        classeId?: string;
    };
    expires: string;
};


export const getAuthSession = async (): Promise<DummySession | null> => {
    
    // Tente de r√©cup√©rer le cookie 'dummyRole'
    const headersList = headers();
    const cookieHeader = headersList.get('cookie');
    const dummyRoleCookie = cookieHeader?.split('; ').find(c => c.startsWith('dummyRole='));

    if (dummyRoleCookie) {
        const role = dummyRoleCookie.split('=')[1];
        
        if (role === 'teacher') {
            console.log('üïµÔ∏è [SESSION BYPASS] - Session PROFESSEUR simul√©e active.');
            return {
                user: {
                    id: 'teacher-id',
                    name: 'Professeur Test',
                    email: 'teacher@example.com',
                    image: `https://api.dicebear.com/7.x/pixel-art/svg?seed=teacher-id`,
                    role: Role.PROFESSEUR,
                },
                expires: new Date(Date.now() + 3600 * 1000).toISOString(),
            };
        }
        
        if (role === 'student') {
             console.log('üïµÔ∏è [SESSION BYPASS] - Session √âL√àVE simul√©e active.');
             // Utilise le premier √©l√®ve des donn√©es factices pour la coh√©rence des ID
             const student = allDummyStudents.find(s => s.email === 'ahmed@example.com');
             
             if (!student) {
                console.error("‚ùå [SESSION BYPASS] - √âl√®ve de d√©mo (ahmed@example.com) non trouv√©.");
                return null;
             }

             return {
                user: {
                    id: student.id,
                    name: student.name,
                    email: student.email,
                    image: student.image ?? `https://api.dicebear.com/7.x/pixel-art/svg?seed=${student.id}`,
                    role: Role.ELEVE,
                    classeId: student.classroomId,
                },
                 expires: new Date(Date.now() + 3600 * 1000).toISOString(),
            };
        }
    }
    
    console.log('üïµÔ∏è [SESSION BYPASS] - Aucune session simul√©e active.');
    // Comportement par d√©faut si aucun cookie de simulation n'est trouv√©
    return null;
};
