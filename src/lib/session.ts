// src/lib/session.ts
import { getServerSession } from "next-auth/next";
import { authOptions } from "./auth-options";
import type { Session } from 'next-auth';
import { headers } from 'next/headers';
import { Role } from "./types";
import { dummyStudentData } from "./dummy-data";

// ---=== BYPASS BACKEND - LOGIQUE DE SESSION FACTICE ===---
// Cette fonction simule la r√©cup√©ration d'une session pour le d√©veloppement
// sans n√©cessiter une v√©ritable authentification. Elle se base sur un cookie.

export const getAuthSession = async (): Promise<Session | null> => {
    
    // Tente de r√©cup√©rer le cookie 'dummyRole'
    const headersList = headers();
    const cookieHeader = headersList.get('cookie');
    const dummyRoleCookie = cookieHeader?.split('; ').find(c => c.startsWith('dummyRole='));

    if (dummyRoleCookie) {
        const role = dummyRoleCookie.split('=')[1];
        
        if (role === 'teacher') {
            console.log('üïµÔ∏è [SESSION BYPASS] - Session PROFESSEUR simul√©e active.');
            return {
                user: {
                    id: 'teacher-id',
                    name: 'Professeur Test',
                    email: 'teacher@example.com',
                    image: `https://api.dicebear.com/7.x/pixel-art/svg?seed=teacher-id`,
                    role: Role.PROFESSEUR,
                },
                expires: new Date(Date.now() + 3600 * 1000).toISOString(),
            };
        }
        
        if (role === 'student') {
             console.log('üïµÔ∏è [SESSION BYPASS] - Session √âL√àVE simul√©e active.');
             const student = dummyStudentData['student1']; // Utilise le premier √©l√®ve pour la d√©mo
             return {
                user: {
                    id: student.id,
                    name: student.name,
                    email: student.email,
                    image: student.image ?? `https://api.dicebear.com/7.x/pixel-art/svg?seed=${student.id}`,
                    role: Role.ELEVE,
                    classeId: student.classe?.id,
                },
                 expires: new Date(Date.now() + 3600 * 1000).toISOString(),
            };
        }
    }
    
    console.log('üïµÔ∏è [SESSION BYPASS] - Aucune session simul√©e active. Utilisation de NextAuth.');
    // Comportement par d√©faut si aucun cookie de simulation n'est trouv√©
    return getServerSession(authOptions);
};
