// src/lib/actions/whiteboard.actions.ts
'use server';

import { pusherTrigger } from '@/lib/pusher/server';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth-options'; // CORRECTION: Importer depuis le fichier centralis√©
import { revalidatePath } from 'next/cache';
import type { TLEditorSnapshot } from '@tldraw/tldraw';

/**
 * Diffuse les mises √† jour de l'√©tat du tableau blanc √† tous les participants d'une session.
 * @param sessionId L'ID de la session.
 * @param snapshot Le snapshot (instantan√©) de l'√©tat du tableau blanc √† diffuser.
 */
export async function broadcastWhiteboardUpdate(sessionId: string, snapshot: any) {
  try {
    const session = await getServerSession(authOptions);
    
    if (!session?.user) {
      console.error('‚ùå [ACTION WHITEBOARD] - Tentative de diffusion non autoris√©e (pas de session).');
      throw new Error('Unauthorized');
    }

    const channelName = `presence-session-${sessionId}`;
    const eventName = 'whiteboard-update';

    console.log(`üé® [ACTION WHITEBOARD] - Diffusion des donn√©es du tableau blanc par ${session.user.id} sur le canal ${channelName}`);
    
    await pusherTrigger(channelName, eventName, {
      senderId: session.user.id,
      snapshot: snapshot,
    });

    return { success: true };
  } catch (error) {
    console.error('üí• [ACTION WHITEBOARD] - Erreur lors de la diffusion des mises √† jour :', error);
    return { success: false, error: 'Failed to broadcast whiteboard update' };
  }
}


/**
 * Diffuse le changement de contr√¥leur du tableau blanc.
 * @param sessionId L'ID de la session.
 * @param controllerId L'ID de l'utilisateur qui prend le contr√¥le.
 */
export async function broadcastWhiteboardController(sessionId: string, controllerId: string) {
  try {
    const session = await getServerSession(authOptions);
    if (session?.user?.role !== 'PROFESSEUR') {
      console.error('‚ùå [ACTION WHITEBOARD] - Seul le professeur peut changer le contr√¥leur.');
      throw new Error('Unauthorized');
    }

    const channelName = `presence-session-${sessionId}`;
    const eventName = 'whiteboard-controller-update';

    console.log(`üïπÔ∏è [ACTION WHITEBOARD] - Le professeur assigne le contr√¥le du tableau blanc √† ${controllerId} sur le canal ${channelName}`);
    
    await pusherTrigger(channelName, eventName, {
      controllerId,
    });

    revalidatePath(`/session/${sessionId}`);
    return { success: true };

  } catch (error) {
    console.error('üí• [ACTION WHITEBOARD] - Erreur lors du changement de contr√¥leur:', error);
    return { success: false, error: 'Failed to change whiteboard controller' };
  }
}

export async function shareDocument(sessionId: string, document: { name: string; url: string }) {
  console.log(`üìÑ [ACTION DOCUMENT] - Partage du document '${document.name}' pour la session ${sessionId}`);
  
  try {
      // üîç DEBUG D√âTAILL√â
      console.log('üîç [ACTION DOCUMENT] - V√©rification de la session...');
      const session = await getServerSession(authOptions);
      
      if (!session?.user) {
          console.error('‚ùå [ACTION DOCUMENT] - Utilisateur non authentifi√© - Session:', session);
          throw new Error('Unauthorized: No user session');
      }

      console.log('‚úÖ [ACTION DOCUMENT] - Session trouv√©e:', session.user.name);
      
      if (!sessionId || !document?.url || !document?.name) {
          console.error('‚ùå [ACTION DOCUMENT] - Param√®tres manquants:', { sessionId, document });
          throw new Error('sessionId et document (name, url) sont requis.');
      }

      const channel = `presence-session-${sessionId}`;
      const payload = {
          name: document.name,
          url: document.url,
          sharedBy: session.user.name,
          timestamp: new Date().toISOString(),
          newHistory: [], // La gestion de l'historique est maintenant c√¥t√© client.
      };
      
      console.log(`üì§ [ACTION DOCUMENT] - Tentative de diffusion sur le canal ${channel}...`);
      console.log('üì¶ Payload:', payload);
      
      await pusherTrigger(channel, 'document-updated', payload);
      
      console.log('‚úÖ [ACTION DOCUMENT] - Document partag√© avec succ√®s!');
      return { success: true };
      
  } catch (error) {
      console.error('üí• [ACTION DOCUMENT] - Erreur d√©taill√©e:', error);
      console.error('üí• Stack:', error instanceof Error ? error.stack : 'No stack');
      throw new Error(`Impossible de partager le document: ${error instanceof Error ? error.message : 'Erreur inconnue'}`);
  }
}
