// src/lib/actions/whiteboard.actions.ts
'use server';

import { pusherTrigger } from '@/lib/pusher/server';
import { getAuthSession } from '../session';
import { revalidatePath } from 'next/cache';

/**
 * Diffuse les mises √† jour de l'√©tat du tableau blanc √† tous les participants d'une session.
 * @param sessionId L'ID de la session.
 * @param snapshot Le snapshot (instantan√©) de l'√©tat du tableau blanc √† diffuser.
 */
export async function broadcastWhiteboardUpdate(sessionId: string, snapshot: any) {
  try {
    const session = await getAuthSession();
    
    if (!session?.user) {
      console.error('‚ùå [ACTION WHITEBOARD] - Tentative de diffusion non autoris√©e (pas de session).');
      throw new Error('Unauthorized');
    }

    const channelName = `presence-session-${sessionId}`;
    const eventName = 'whiteboard-update';

    console.log(`üé® [ACTION WHITEBOARD] - Diffusion des donn√©es du tableau blanc par ${session.user.id} sur le canal ${channelName}`);
    
    await pusherTrigger(channelName, eventName, {
      senderId: session.user.id,
      snapshot: snapshot,
    });

    return { success: true };
  } catch (error) {
    console.error('üí• [ACTION WHITEBOARD] - Erreur lors de la diffusion des mises √† jour :', error);
    return { success: false, error: 'Failed to broadcast whiteboard update' };
  }
}


/**
 * Diffuse le changement de contr√¥leur du tableau blanc.
 * @param sessionId L'ID de la session.
 * @param controllerId L'ID de l'utilisateur qui prend le contr√¥le.
 */
export async function broadcastWhiteboardController(sessionId: string, controllerId: string) {
  try {
    const session = await getAuthSession();
    if (session?.user?.role !== 'PROFESSEUR') {
      console.error('‚ùå [ACTION WHITEBOARD] - Seul le professeur peut changer le contr√¥leur.');
      throw new Error('Unauthorized');
    }

    const channelName = `presence-session-${sessionId}`;
    const eventName = 'whiteboard-controller-update';

    console.log(`üïπÔ∏è [ACTION WHITEBOARD] - Le professeur assigne le contr√¥le du tableau blanc √† ${controllerId} sur le canal ${channelName}`);
    
    await pusherTrigger(channelName, eventName, {
      controllerId,
    });

    revalidatePath(`/session/${sessionId}`);
    return { success: true };

  } catch (error) {
    console.error('üí• [ACTION WHITEBOARD] - Erreur lors du changement de contr√¥leur:', error);
    return { success: false, error: 'Failed to change whiteboard controller' };
  }
}
