// src/lib/actions/task.actions.ts
'use server';

import { revalidatePath } from 'next/cache';
import { Task, StudentProgress, ProgressStatus } from '@/lib/types';
import { getAuthSession } from '../session';

// ---=== BYPASS BACKEND ===---
export async function createTask(formData: FormData): Promise<Task[]> {
  const title = formData.get('title');
  console.log(`üìù [ACTION T√ÇCHE] - Cr√©ation de la t√¢che (factice): "${title}"`);
  revalidatePath('/teacher/tasks');
  // Retourne un tableau vide car la logique client est optimiste
  return [];
}

export async function updateTask(formData: FormData): Promise<Task[]> {
  const taskId = formData.get('id');
  const title = formData.get('title');
  console.log(`üìù [ACTION T√ÇCHE] - Mise √† jour de la t√¢che ${taskId} (factice): "${title}"`);
  revalidatePath('/teacher/tasks');
  return [];
}

export async function deleteTask(id: string): Promise<Task[]> {
    console.log(`üóëÔ∏è [ACTION T√ÇCHE] - Suppression de la t√¢che ${id} (factice)`);
    revalidatePath('/teacher/tasks');
    return [];
}


export async function completeTask(taskId: string, submissionUrl?: string): Promise<StudentProgress> {
  const session = await getAuthSession();
  const studentId = session?.user?.id;

  if (!studentId) {
    console.error('‚ùå [ACTION T√ÇCHE] - Tentative de compl√©tion de t√¢che sans session √©l√®ve.');
    throw new Error("Authentification requise.");
  }
  
  console.log(`‚úÖ [ACTION T√ÇCHE] - L'√©l√®ve ${studentId} soumet la t√¢che ${taskId}.`);
  if (submissionUrl) {
    console.log(`  -> Preuve soumise (URL): ${submissionUrl}`);
  } else {
    console.log(`  -> Pas de preuve soumise (validation simple ou parentale).`);
  }
  
  // Simule la revalidation pour mettre √† jour l'interface de l'√©l√®ve
  revalidatePath(`/student/dashboard`);
  // Revalide aussi la page des validations pour le prof
  revalidatePath('/teacher/validations');

  // Retourne un objet de progression factice pour l'UI
  return {
    id: `progress-${Date.now()}`,
    studentId: studentId,
    taskId: taskId,
    status: 'PENDING_VALIDATION' as ProgressStatus,
    completionDate: new Date(),
    submissionUrl: submissionUrl || null,
    pointsAwarded: 0,
    accuracy: null,
    recipeName: null,
  };
}
// ---=========================---
