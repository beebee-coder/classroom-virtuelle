// src/lib/actions/activity.actions.ts
'use server';

import { getServerSession } from 'next-auth';
import { authOptions } from '@/app/api/auth/[...nextauth]/route';

const POINTS_PER_INTERVAL = 20;
const MAX_DAILY_POINTS = 200;

// ---=== BYPASS: LOGIQUE SANS PRISMA ===---
// Cette action est simul√©e et n'affecte aucune base de donn√©es.
export async function trackStudentActivity(activeSeconds: number) {
  try {
    const session = await getServerSession(authOptions);
    const userId = session?.user?.id;
    
    if (!userId || session?.user?.role !== 'ELEVE') {
      console.log('üë§ [SERVEUR - Heartbeat] Action ignor√©e: Non-√©l√®ve.');
      return { success: true, pointsAwarded: 0, reason: 'Not an authenticated student' };
    }
    
    console.log(`üíì [SERVEUR - Heartbeat] Ping Re√ßu (factice): √âl√®ve ${userId}.`);

    // La logique de transaction et de mise √† jour de la base de donn√©es est supprim√©e.
    // On simule simplement l'attribution de points pour le logging.
    const pointsToAward = POINTS_PER_INTERVAL;
    console.log(`üí∞ [SERVEUR - Heartbeat] Effet (factice): +${pointsToAward} points pour ${userId}.`);

    return { 
      success: true, 
      pointsAwarded: pointsToAward,
      dailyPoints: (Math.random() * 100) + pointsToAward // Valeur factice
    };

  } catch (error) {
    console.error('‚ùå [SERVEUR - Heartbeat] Erreur:', error);
    throw new Error('Failed to track activity.');
  }
}
