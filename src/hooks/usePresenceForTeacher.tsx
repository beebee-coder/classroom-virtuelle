// src/hooks/usePresenceForTeacher.tsx
'use client';

import { useEffect, useState, useRef } from 'react';
import { getPusherClient } from '@/lib/pusher/client';
import type { PresenceChannel, Members } from 'pusher-js';

interface UsePresenceForTeacherReturn {
  onlineUsers: string[];
  isConnected: boolean;
  error: string | null;
}

export const usePresenceForTeacher = (
  userId?: string, 
  classroomId?: string, 
  enabled: boolean = true
): UsePresenceForTeacherReturn => {
  const [onlineUsers, setOnlineUsers] = useState<string[]>([]);
  const [isConnected, setIsConnected] = useState(false);
  const [error, setError] = useState<string | null>(null);
  
  const channelRef = useRef<PresenceChannel | null>(null);

  useEffect(() => {
    // Validation des param√®tres et de l'√©tat "enabled"
    if (!enabled || !userId || !classroomId) {
      if (channelRef.current) {
        const pusherClient = getPusherClient();
        console.log('üîö [PRESENCE PROF] - D√©sactivation, nettoyage du canal existant.');
        pusherClient.unsubscribe(channelRef.current.name);
        channelRef.current = null;
        setIsConnected(false);
        setOnlineUsers([]);
      }
      return;
    }

    const pusherClient = getPusherClient();
    const channelName = `presence-class-${classroomId}`;

    // √âviter les doubles abonnements si le canal n'a pas chang√©
    if (channelRef.current?.name === channelName && isConnected) {
      console.log('‚è≠Ô∏è [PRESENCE PROF] - D√©j√† abonn√© et connect√©, ignor√©.');
      return;
    }

    console.log(`üïµÔ∏è [PRESENCE PROF] - Tentative d'abonnement au canal: ${channelName}`);

    try {
      // Nettoyer l'ancien canal avant de s'abonner √† un nouveau
      if (channelRef.current) {
        pusherClient.unsubscribe(channelRef.current.name);
      }
      
      const channel = pusherClient.subscribe(channelName) as PresenceChannel;
      channelRef.current = channel;

      const handleSubscriptionSucceeded = (data: { members: Members }) => {
        console.log(`‚úÖ [PRESENCE PROF] - Abonnement r√©ussi au canal ${channelName}`);
        setIsConnected(true);
        setError(null);
        
        const userList = Object.keys(data.members || {});
        const otherUsers = userList.filter(id => id !== userId);
        setOnlineUsers(otherUsers);
        console.log(`üìä [PRESENCE PROF] - √âl√®ves actuellement en ligne:`, otherUsers);
      };

      const handleMemberAdded = (member: { id: string }) => {
        if (member.id !== userId) {
          console.log(`‚ûï [PRESENCE PROF] - Nouvel √©l√®ve connect√©:`, member.id);
          setOnlineUsers(prev => {
            if (!prev.includes(member.id)) {
              return [...prev, member.id];
            }
            return prev;
          });
        }
      };

      const handleMemberRemoved = (member: { id: string }) => {
        console.log(`‚ûñ [PRESENCE PROF] - √âl√®ve d√©connect√©:`, member.id);
        setOnlineUsers(prev => prev.filter(id => id !== member.id));
      };

      const handleSubscriptionError = (status: any) => {
        console.error(`‚ùå [PRESENCE PROF] - Erreur d'abonnement au canal ${channelName}:`, status);
        setError('Erreur de connexion au service de pr√©sence');
        setIsConnected(false);
      };

      // Lier les √©v√©nements
      channel.bind('pusher:subscription_succeeded', handleSubscriptionSucceeded);
      channel.bind('pusher:member_added', handleMemberAdded);
      channel.bind('pusher:member_removed', handleMemberRemoved);
      channel.bind('pusher:subscription_error', handleSubscriptionError);

      return () => {
        console.log(`üîö [PRESENCE PROF] - Nettoyage des √©couteurs et d√©sabonnement du canal ${channelName}`);
        if (channelRef.current) {
          // Utiliser un try-catch pour le nettoyage car les unbind peuvent √©chouer si le canal est d√©j√† ferm√©
          try {
            channelRef.current.unbind_all();
            pusherClient.unsubscribe(channelName);
          } catch(e) {
            console.warn(`‚ö†Ô∏è [PRESENCE PROF] - Avertissement lors du nettoyage du canal ${channelName}:`, e)
          }
          channelRef.current = null;
        }
      };

    } catch (err) {
      console.error('üí• [PRESENCE PROF] - Erreur critique lors de l\'initialisation de Pusher:', err);
      setError('Erreur critique de connexion');
      setIsConnected(false);
    }
  }, [userId, classroomId, enabled, isConnected]); // isConnected ajout√© pour retenter la connexion si elle √©choue

  return { 
    onlineUsers, 
    isConnected, 
    error 
  };
};
