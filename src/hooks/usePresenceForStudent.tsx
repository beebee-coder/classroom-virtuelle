// src/hooks/usePresenceForStudent.tsx
'use client';

import { useEffect, useState, useRef } from 'react';
import { pusherClient } from '@/lib/pusher/client';
import type { PresenceChannel } from 'pusher-js';

interface UsePresenceForStudentReturn {
  isConnected: boolean;
  error: string | null;
  teacherOnline: boolean;
}

export const usePresenceForStudent = (
  userId?: string,
  classroomId?: string,
  enabled: boolean = true
): UsePresenceForStudentReturn => {
  const [isConnected, setIsConnected] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [teacherOnline, setTeacherOnline] = useState(false);
  
  const channelRef = useRef<PresenceChannel | null>(null);

  useEffect(() => {
    // Validation des param√®tres et de l'√©tat "enabled"
    if (!enabled || !userId || !classroomId) {
      if (channelRef.current) {
        console.log('üîö [PRESENCE ELEVE] - D√©sactivation, nettoyage du canal existant.');
        pusherClient.unsubscribe(channelRef.current.name);
        channelRef.current = null;
        setIsConnected(false);
        setTeacherOnline(false);
      }
      return;
    }

    const channelName = `presence-class-${classroomId}`;

    // √âviter les doubles abonnements si le canal n'a pas chang√©
    if (channelRef.current?.name === channelName && isConnected) {
      console.log('‚è≠Ô∏è [PRESENCE ELEVE] - D√©j√† abonn√© et connect√©, ignor√©.');
      return;
    }

    console.log(`üïµÔ∏è [PRESENCE ELEVE] - Tentative d'abonnement au canal: ${channelName}`);

    try {
      // Nettoyer l'ancien canal avant de s'abonner √† un nouveau
      if (channelRef.current) {
        pusherClient.unsubscribe(channelRef.current.name);
      }
      
      const channel = pusherClient.subscribe(channelName) as PresenceChannel;
      channelRef.current = channel;

      const handleSubscriptionSucceeded = (data: { members: any }) => {
        console.log(`‚úÖ [PRESENCE ELEVE] - Abonnement r√©ussi au canal ${channelName}`);
        setIsConnected(true);
        setError(null);
        
        // V√©rifier si le professeur est en ligne
        const members = data.members || {};
        const memberIds = Object.keys(members);
        const hasTeacher = memberIds.some(id => 
          members[id]?.role === 'PROFESSEUR' || id !== userId
        );
        
        setTeacherOnline(hasTeacher);
        console.log(`üë®‚Äçüè´ [PRESENCE ELEVE] - Professeur en ligne: ${hasTeacher}`, memberIds);
      };

      const handleMemberAdded = (member: { id: string; info?: any }) => {
        console.log(`‚ûï [PRESENCE ELEVE] - Nouveau membre connect√©:`, member.id);
        
        // Si le membre ajout√© n'est pas l'√©l√®ve actuel, c'est probablement le professeur
        if (member.id !== userId) {
          setTeacherOnline(true);
          console.log('üë®‚Äçüè´ [PRESENCE ELEVE] - Professeur d√©tect√© en ligne');
        }
      };

      const handleMemberRemoved = (member: { id: string }) => {
        console.log(`‚ûñ [PRESENCE ELEVE] - Membre d√©connect√©:`, member.id);
        
        // Si le membre d√©connect√© n'est pas l'√©l√®ve actuel, v√©rifier s'il reste d'autres membres
        if (member.id !== userId) {
          // On suppose que c'√©tait le professeur qui s'est d√©connect√©
          setTeacherOnline(false);
          console.log('üë®‚Äçüè´ [PRESENCE ELEVE] - Professeur d√©connect√©');
        }
      };

      const handleSubscriptionError = (status: any) => {
        console.error(`‚ùå [PRESENCE ELEVE] - Erreur d'abonnement au canal ${channelName}:`, status);
        setError('Erreur de connexion au service de pr√©sence');
        setIsConnected(false);
        setTeacherOnline(false);
      };

      // Lier les √©v√©nements
      channel.bind('pusher:subscription_succeeded', handleSubscriptionSucceeded);
      channel.bind('pusher:member_added', handleMemberAdded);
      channel.bind('pusher:member_removed', handleMemberRemoved);
      channel.bind('pusher:subscription_error', handleSubscriptionError);

      return () => {
        console.log(`üîö [PRESENCE ELEVE] - Nettoyage des √©couteurs et d√©sabonnement du canal ${channelName}`);
        if (channelRef.current) {
          try {
            channelRef.current.unbind_all();
            pusherClient.unsubscribe(channelName);
          } catch(e) {
            console.warn(`‚ö†Ô∏è [PRESENCE ELEVE] - Avertissement lors du nettoyage du canal ${channelName}:`, e);
          }
          channelRef.current = null;
        }
        setIsConnected(false);
        setTeacherOnline(false);
      };

    } catch (err) {
      console.error('üí• [PRESENCE ELEVE] - Erreur critique lors de l\'initialisation de Pusher:', err);
      setError('Erreur critique de connexion');
      setIsConnected(false);
      setTeacherOnline(false);
    }
  }, [userId, classroomId, enabled]);

  return { 
    isConnected, 
    error,
    teacherOnline 
  };
};
