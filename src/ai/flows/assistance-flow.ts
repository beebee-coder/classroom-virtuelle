/**
 * @fileoverview Flow d'assistance p√©dagogique avec Gemini, utilisant un appel direct √† l'API.
 */
'use server';

import { GoogleAuth } from 'google-auth-library';

export async function askAssistance(question: string): Promise<{ answer: string }> {
  // Validation simple de la question
  if (!question?.trim() || question.length < 3) {
    return {
      answer: "‚ùì **Question trop courte** : Pourriez-vous formuler une question plus pr√©cise ?"
    };
  }

  const projectId = process.env.GOOGLE_PROJECT_ID;
  const apiKey = process.env.GEMINI_API_KEY;

  if (!apiKey || !projectId) {
    console.error('‚ùå ERREUR CONFIGURATION: Cl√© API Gemini ou Project ID manquant.');
    throw new Error('Configuration API manquante.');
  }

  const model = 'gemini-1.5-flash-001'; // Mod√®le stable et confirm√©
  const location = 'us-central1'; // Emplacement standard

  const prompt = `
Tu es "Clary", un assistant p√©dagogique expert pour coll√©giens fran√ßais.
Ton r√¥le est d'aider √† comprendre, pas de donner les r√©ponses toutes faites.

QUESTION DE L'√âL√àVE: "${question}"

GUIDELINES STRICTES:
- Explique le concept de mani√®re simple et concr√®te.
- Utilise des exemples de la vie quotidienne.
- Donne des m√©thodes et indices, JAMAIS la r√©ponse finale.
- Sois encourageant et positif.
- Structure en 3 parties claires.

STRUCTURE DE R√âPONSE:
1. üß† **Explication** : Valide la question et explique le concept clairement.
2. üí° **M√©thode** : Donne une piste pour trouver la solution soi-m√™me.
3. ‚ú® **Encouragement** : Termine par une phrase motivante.

Langue: Fran√ßais uniquement.
Style: Chaleureux, accessible, p√©dagogique.
  `;
  
  const requestBody = {
    contents: [
      {
        role: 'user',
        parts: [{ text: prompt }]
      }
    ]
  };

  try {
    console.log(`üìö Assistance demand√©e pour: "${question.substring(0, 50)}..."`);
    const endpoint = `https://${location}-aiplatform.googleapis.com/v1/projects/${projectId}/locations/${location}/publishers/google/models/${model}:generateContent`;

    const response = await fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`,
      },
      body: JSON.stringify(requestBody)
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error(`‚ùå Erreur API Gemini (${response.status}):`, errorText);
      throw new Error(`Erreur API Gemini: ${response.statusText}`);
    }

    const data = await response.json();
    const aiResponse = data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim();

    if (!aiResponse) {
      throw new Error('R√©ponse vide de l\'API Gemini.');
    }

    console.log('‚úÖ Assistance fournie avec succ√®s');
    return { answer: aiResponse };

  } catch (error: any) {
    console.error('‚ùå Erreur dans askAssistance:', error);
    
    return {
      answer: `üß† **Explication** : Je rencontre une difficult√© technique momentan√©e.\n\nüí° **Conseil** : Pour "${question}", je vous sugg√®re de :\n‚Ä¢ Consulter vos cours et manuels.\n‚Ä¢ Noter les points pr√©cis qui vous bloquent.\n‚Ä¢ En parler avec votre professeur.\n\n‚ú® **Encouragement** : Les obstacles passent, mais votre curiosit√© reste ! Continuez !`
    };
  }
}
