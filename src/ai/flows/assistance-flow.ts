/**
 * @fileoverview Defines a server action for providing educational assistance.
 */
'use server';

import { runAIGeneration } from '@/ai/config';
import { AssistanceOutput } from '@/ai/schemas';

export async function askAssistance(question: string): Promise<AssistanceOutput> {
  // ‚úÖ VALIDATION DE LA QUESTION
  if (!question || question.trim().length < 2) {
    return {
      answer: "‚ùì **Question trop courte** : Pourriez-vous formuler une question plus pr√©cise ?\n\nüí° **Conseil** : Plus votre question est d√©taill√©e, mieux je pourrai vous aider !\n\n‚ú® **Encouragement** : N'h√©sitez pas √† expliquer ce qui vous pose probl√®me."
    };
  }

  if (question.length > 1000) {
    return {
      answer: "üìù **Question trop longue** : Pourriez-vous r√©sumer votre question en quelques phrases ?\n\nüí° **Conseil** : Posez une question pr√©cise sur un concept sp√©cifique.\n\n‚ú® **Encouragement** : C'est excellent de vouloir tout expliquer ! Commen√ßons par un point pr√©cis."
    };
  }

  // ‚úÖ PROMPT AM√âLIOR√â
  const prompt = `
Tu es Clary, un assistant p√©dagogique expert pour coll√©giens en France.
Ton r√¥le est d'aider √† comprendre, pas de donner les r√©ponses.

R√àGLES STRICTES :
- EXPLIQUE les concepts simplement avec des exemples concrets
- DONNE des indices et m√©thodes, JAMAIS la r√©ponse finale
- UTILISE des m√©taphores et analogies
- SOIS encourageant et positif
- FORMAT en 3 parties claires

Question de l'√©l√®ve : "${question}"

Structure ta r√©ponse :
1. **Explication** üß† : Valide la question et explique le concept
2. **M√©thode** üí° : Donne une piste pour trouver la solution
3. **Motivation** ‚ú® : Encourage avec une phrase positive
  `;

  try {
    console.log('[Assistance] Processing question:', question.substring(0, 100));
    const generatedText = await runAIGeneration(prompt);
    
    // ‚úÖ NETTOYAGE DE LA R√âPONSE
    const cleanAnswer = generatedText.trim();
    
    if (!cleanAnswer || cleanAnswer.length < 10) {
      throw new Error('R√©ponse AI vide');
    }
    
    return { answer: cleanAnswer };
    
  } catch (error) {
    console.error('[Assistance Error]', error);
    
    // ‚úÖ FALLBACK ROBUSTE
    return {
      answer: `üß† **Explication** : Je suis Clary, votre assistant ! Actuellement, je rencontre un probl√®me technique.\n\nüí° **Conseil** : Pour "${question}", consultez vos ressources de cours ou √©changez avec votre professeur.\n\n‚ú® **Encouragement** : Votre pers√©v√©rance est la cl√© de la r√©ussite ! Cette difficult√© technique passera.`
    };
  }
}