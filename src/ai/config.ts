/**
 * @fileoverview Configuration r√©elle pour Google Gemini API
 */
import { GoogleGenerativeAI } from '@google/generative-ai';

export async function runAIGeneration(prompt: string): Promise<string> {
  const apiKey = process.env.GEMINI_API_KEY;

  // üî¥ V√âRIFICATION CRITIQUE - Avez-vous mis la cl√© dans .env.local ?
  if (!apiKey || !apiKey.startsWith('AIza')) {
    console.error('‚ùå ERREUR CONFIGURATION: Cl√© API manquante ou invalide');
    console.error('üí° SOLUTION: Ajoutez GEMINI_API_KEY=votre_cl√©_r√©elle dans .env.local');
    throw new Error('Configuration API manquante. V√©rifiez votre cl√© Gemini.');
  }

  try {
    console.log('üîÑ Appel de l\'API Gemini...');
    
    const genAI = new GoogleGenerativeAI(apiKey);
    const model = genAI.getGenerativeModel({
      model: 'gemini-1.5-flash',
      generationConfig: {
        temperature: 0.7,
        topP: 0.8,
        topK: 40,
        maxOutputTokens: 1024,
      },
    });

    const result = await model.generateContent(prompt);
    const response = await result.response;
    
    console.log('‚úÖ R√©ponse Gemini re√ßue avec succ√®s');
    return response.text();

  } catch (error: any) {
    console.error('‚ùå Erreur API Gemini:', {
      message: error.message,
      status: error.status,
      code: error.code
    });

    // Gestion d'erreurs d√©taill√©e
    if (error.message?.includes('API_KEY_INVALID')) {
      throw new Error('Cl√© API invalide. V√©rifiez votre cl√© Gemini dans Google AI Studio.');
    }
    if (error.message?.includes('quota')) {
      throw new Error('Quota API d√©pass√©. V√©rifiez votre usage dans Google Cloud Console.');
    }
    if (error.message?.includes('PERMISSION_DENIED')) {
      throw new Error('Permission refus√©e. V√©rifiez que l\'API Gemini est activ√©e.');
    }
    if (error.message?.includes('503') || error.message?.includes('service unavailable')) {
      throw new Error('Service temporairement indisponible. R√©essayez dans quelques minutes.');
    }

    throw new Error(`Erreur API: ${error.message || 'Probl√®me de connexion'}`);
  }
}
