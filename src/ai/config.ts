/**
 * @fileoverview This file initializes and configures the Google Generative AI client.
 */

import { GoogleGenerativeAI } from '@google/generative-ai';

export async function runAIGeneration(prompt: string): Promise<string> {
  const apiKey = process.env.GEMINI_API_KEY;
  
  console.log('[AI Debug] API Key exists:', !!apiKey);
  console.log('[AI Debug] First 10 chars of key:', apiKey ? `${apiKey.substring(0, 10)}...` : 'none');

  // âœ… SOLUTION TEMPORAIRE - Fallback Ã©ducatif si pas de clÃ©
  if (!apiKey || apiKey.length < 10) {
    console.warn('[AI Warning] Using fallback response - no valid API key');
    return `ðŸ§  **Explication** : Je suis votre assistant pÃ©dagogique ! Actuellement, le service AI est en configuration.\n\nðŸ’¡ **Conseil** : Pour une aide immÃ©diate, consultez vos manuels ou posez votre question Ã  votre professeur.\n\nâœ¨ **Encouragement** : Votre curiositÃ© est votre meilleur atout pour apprendre ! Continuez Ã  poser des questions !`;
  }

  try {
    const genAI = new GoogleGenerativeAI(apiKey);
    const model = genAI.getGenerativeModel({
      model: 'gemini-1.5-flash-latest',
      generationConfig: {
        temperature: 0.7,
        maxOutputTokens: 1000,
      },
    });

    console.log('[AI Debug] Calling Gemini API...');
    const result = await model.generateContent(prompt);
    const response = await result.response;
    
    console.log('[AI Success] Response received');
    return response.text();
    
  } catch (error: any) {
    console.error('[AI Generation Error Details]:', error);
    
    // âœ… MESSAGES D'ERREUR SPÃ‰CIFIQUES
    if (error.message?.includes('API_KEY') || error.message?.includes('key invalid')) {
      throw new Error('Configuration: ClÃ© API Gemini invalide. VÃ©rifiez votre clÃ© dans .env.local');
    }
    if (error.message?.includes('quota') || error.message?.includes('rate limit')) {
      throw new Error('Quota API dÃ©passÃ©. RÃ©essayez dans quelques minutes.');
    }
    if (error.message?.includes('PERMISSION_DENIED') || error.message?.includes('403')) {
      throw new Error('AccÃ¨s refusÃ©. VÃ©rifiez que votre clÃ© API est valide.');
    }
    
    // âœ… FALLBACK EN CAS D'ERREUR RÃ‰SEAU
    console.warn('[AI Fallback] Using educational fallback due to API error');
    return `ðŸ§  **Explication** : Je rencontre actuellement des difficultÃ©s techniques avec le service d'assistance.\n\nðŸ’¡ **Conseil** : Pour progresser sur votre question "${prompt.substring(0, 50)}...", je vous suggÃ¨re de :\nâ€¢ Consulter vos cours et manuels\nâ€¢ Ã‰changer avec vos camarades\nâ€¢ Demander Ã  votre professeur\n\nâœ¨ **Encouragement** : Ne vous dÃ©couragez pas ! Chercher des rÃ©ponses fait partie de l'apprentissage.`;
  }
}
