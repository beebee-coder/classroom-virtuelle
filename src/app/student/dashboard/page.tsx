// src/app/student/dashboard/page.tsx
import { Header } from '@/components/Header';
import { notFound, redirect } from 'next/navigation';
import { CareerThemeWrapper } from '@/components/CareerThemeWrapper';
import { auth } from '@/auth';
import { ChatSheet } from '@/components/ChatSheet';
import { getStudentAnnouncements } from '@/lib/actions/announcement.actions';
import { getStudentData } from '@/lib/actions/student.actions';
import StudentPageClient from '@/components/StudentPageClient';
import { Sidebar, SidebarContent, SidebarInset, SidebarProvider, SidebarTrigger } from '@/components/ui/sidebar';
import Menu from '@/components/Menu';
import prisma from '@/lib/prisma';
import type { User, Metier, Announcement, StudentProgress, Task, Classroom, EtatEleve } from '@prisma/client';

export const dynamic = 'force-dynamic';

// Type coh√©rent avec ce que retourne getStudentData
type StudentWithDetails = User & {
    classe: Classroom | null;
    etat: (EtatEleve & { metier: Metier | null }) | null;
    studentProgress: StudentProgress[];
};

type AnnouncementWithAuthor = Announcement & {
    author: { name: string | null };
};

// CORRECTION: Composant d'erreur sans interactivit√©
function StudentDashboardError({ message }: { message: string }) {
  return (
    <div className="min-h-screen flex items-center justify-center bg-background">
      <div className="text-center">
        <h1 className="text-2xl font-bold text-destructive mb-4">Erreur</h1>
        <p className="text-muted-foreground mb-6">{message}</p>
        <p className="text-sm text-muted-foreground">
          Veuillez recharger la page ou contacter l'administrateur.
        </p>
      </div>
    </div>
  );
}

export default async function StudentDashboardPage() {
    console.log('üßë‚Äçüéì [PAGE] - Chargement du tableau de bord √©l√®ve.');

    // Authentification
    const session = await auth();
    if (!session?.user?.id || session.user.role !== 'ELEVE') {
        console.log('üîí [PAGE ELEVE] - Redirection: utilisateur non authentifi√© ou non √©l√®ve');
        redirect('/login');
    }

    console.log(`‚úÖ [PAGE ELEVE] - Session trouv√©e pour: ${session.user.name} (${session.user.id})`);

    let student: StudentWithDetails | null = null;
    try {
        student = await getStudentData(session.user.id);
    } catch (studentError) {
        console.error('‚ùå [PAGE ELEVE] - Erreur lors du chargement des donn√©es √©l√®ve:', studentError);
        return (
            <StudentDashboardError 
                message="Impossible de charger vos donn√©es. Veuillez v√©rifier votre connexion et r√©essayer." 
            />
        );
    }

    if (!student) {
        console.error('‚ùå [PAGE ELEVE] - Aucune donn√©e retourn√©e par getStudentData. Affichage de la page Not Found.');
        notFound();
    }
    
    console.log('‚úÖ [PAGE ELEVE] - Donn√©es de l\'√©l√®ve charg√©es:', student.name);

    // Chargement des donn√©es suppl√©mentaires
    const metier = student.etat?.metier;
    const classeId = student.classe?.id;

    console.log(`üìä [PAGE ELEVE] - M√©tier: ${metier?.nom || 'Aucun'}, Classe: ${classeId || 'Aucune'}`);

    // Chargement parall√®le des donn√©es pour de meilleures performances
    const [announcements, tasks, allCareers] = await Promise.allSettled([
        getStudentAnnouncements(student.id).catch(err => {
            console.error('‚ùå [PAGE ELEVE] - Erreur lors du chargement des annonces:', err);
            return [] as AnnouncementWithAuthor[]; // Retourner un tableau vide en cas d'erreur
        }),
        
        prisma.task.findMany({ where: { isActive: true } }).catch(err => {
            console.error('‚ùå [PAGE ELEVE] - Erreur lors du chargement des t√¢ches:', err);
            return [] as Task[]; // Retourner un tableau vide en cas d'erreur
        }),
        
        prisma.metier.findMany().catch(err => {
            console.error('‚ùå [PAGE ELEVE] - Erreur lors du chargement des m√©tiers:', err);
            return [] as Metier[]; // Retourner un tableau vide en cas d'erreur
        })
    ]);

    // Extraction des r√©sultats avec gestion d'erreur
    const announcementsData = announcements.status === 'fulfilled' ? announcements.value : [];
    const tasksData = tasks.status === 'fulfilled' ? tasks.value : [];
    const allCareersData = allCareers.status === 'fulfilled' ? allCareers.value : [];

    console.log(`üì¶ [PAGE ELEVE] - Donn√©es suppl√©mentaires charg√©es: ${announcementsData.length} annonces, ${tasksData.length} t√¢ches, ${allCareersData.length} m√©tiers.`);

    return (
        <CareerThemeWrapper career={metier ?? undefined}>
            <SidebarProvider>
                <div className="flex flex-col min-h-screen w-full">
                    <Header user={session.user}>
                        <div className="flex items-center gap-2">
                            <SidebarTrigger />
                            {classeId && session.user.role && (
                                <ChatSheet 
                                    classroomId={classeId} 
                                    userId={session.user.id} 
                                    userRole={session.user.role} 
                                />
                            )}
                        </div>
                    </Header>
                    <div className="flex flex-1">
                        <Sidebar>
                            <SidebarContent>
                                <Menu user={session.user} />
                            </SidebarContent>
                        </Sidebar>
                        <SidebarInset>
                            <StudentPageClient
                                student={student}
                                announcements={announcementsData}
                                allCareers={allCareersData}
                                isTeacherView={false}
                                tasks={tasksData}
                                user={session.user}
                            />
                        </SidebarInset>
                    </div>
                </div>
            </SidebarProvider>
        </CareerThemeWrapper>
    );
}
