
// src/app/teacher/class/[id]/ClassPageClient.tsx - Version avec simulation de pr√©sence
'use client';

import { useState, useCallback, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Checkbox } from '@/components/ui/checkbox';
import { createCoursSession } from '@/lib/actions/session.actions';
import { useRouter } from 'next/navigation';
import { useToast } from '@/hooks/use-toast';
import { CreateAnnouncementForm } from '@/components/CreateAnnouncementForm';
import { AddStudentForm } from './AddStudentForm';
import { ClassroomWithDetails, StudentForCard, AnnouncementWithAuthor } from '@/lib/types';
import { User } from 'next-auth';
import { AnnouncementCarousel } from '@/components/AnnouncementCarousel';
import { BackButton } from '@/components/BackButton';
import { Video, XSquare, Crown, Loader2, Wifi, WifiOff } from 'lucide-react';
import { pusherClient } from '@/lib/pusher/client';
import type { PresenceChannel } from 'pusher-js';
import { cn } from '@/lib/utils';
import { useSession } from 'next-auth/react';

interface ClassPageClientProps {
    classroom: ClassroomWithDetails;
    teacher: User;
    announcements: AnnouncementWithAuthor[];
}

// ID de l'√©l√®ve de d√©mo connect√©
const SIMULATED_ONLINE_STUDENT_ID = 'student1';

export default function ClassPageClient({ classroom, teacher, announcements }: ClassPageClientProps) {
    const [selectedStudents, setSelectedStudents] = useState<string[]>([]);
    const [isStartingSession, setIsStartingSession] = useState<boolean>(false);
    const [onlineStudents, setOnlineStudents] = useState<string[]>([]);
    const [isSimulationMode, setIsSimulationMode] = useState<boolean>(true);
    const router = useRouter();
    const { toast } = useToast();
    const { data: session } = useSession();

    // Simulation de pr√©sence pour le d√©veloppement
    useEffect(() => {
        if (isSimulationMode) {
            console.log('üéÆ [PRESENCE SIMULATION] - Seul l\'√©l√®ve connect√© (ID: student1) est affich√© comme en ligne.');
            setOnlineStudents([SIMULATED_ONLINE_STUDENT_ID]);
        }
    }, [isSimulationMode]);

    // Abonnement r√©el Pusher (d√©sactiv√© en simulation)
    useEffect(() => {
        if (!isSimulationMode && classroom.id && session?.user?.id) {
            console.log("üë®‚Äçüè´ [PRESENCE PROF] - Abonnement r√©el Pusher activ√©", { classroomId: classroom.id, userId: session.user.id });

            const channelName = `presence-class-${classroom.id}`;
            console.log(`üë®‚Äçüè´ [PRESENCE PROF] - Tentative d'abonnement au canal: ${channelName}`);
            
            try {
                const channel = pusherClient.subscribe(channelName) as PresenceChannel;

                const updateOnlineMembers = () => {
                    if (channel.members?.members) {
                        const memberIds = Object.keys(channel.members.members);
                        console.log('üë®‚Äçüè´ [PRESENCE PROF] - Mise √† jour des membres. IDs re√ßus de Pusher:', memberIds);
                        const studentMemberIds = memberIds.filter(id => id !== session.user?.id);
                        setOnlineStudents(studentMemberIds);
                        console.log('üë®‚Äçüè´ [PRESENCE PROF] - Liste des √©l√®ves en ligne mise √† jour:', studentMemberIds);
                    }
                };

                channel.bind('pusher:subscription_succeeded', (members: any) => {
                    console.log('‚úÖ [PRESENCE PROF] - Abonnement r√©ussi. Membres actuels:', members.members);
                    updateOnlineMembers();
                });
                
                channel.bind('pusher:member_added', (member: { id: string, info: any }) => {
                    console.log('‚ûï [PRESENCE PROF] - Membre ajout√©:', member);
                    updateOnlineMembers();
                });
                
                channel.bind('pusher:member_removed', (member: { id: string, info: any }) => {
                    console.log('‚ûñ [PRESENCE PROF] - Membre retir√©:', member);
                    updateOnlineMembers();
                });

                return () => {
                    console.log(`üîö [PRESENCE PROF] - D√©sabonnement du canal ${channelName}`);
                    pusherClient.unsubscribe(channelName);
                };
            } catch (error) {
                console.error("‚ùå [PRESENCE PROF] - Erreur lors de l'abonnement Pusher:", error);
                // Retour √† la simulation en cas d'erreur
                setIsSimulationMode(true);
                toast({
                    variant: 'destructive',
                    title: 'Erreur de pr√©sence',
                    description: 'Mode simulation activ√©',
                });
            }
        }
    }, [classroom.id, session?.user?.id, isSimulationMode, toast]);

    // Validation des props
    if (!classroom?.id || !teacher?.id) {
        console.error('‚ùå [CLIENT] - Props manquants:', { classroom, teacher });
        toast({
            variant: 'destructive',
            title: 'Erreur de chargement',
            description: 'Donn√©es de classe ou professeur manquantes.',
        });
        return null;
    }

    const handleSelectStudent = useCallback((studentId: string) => {
        if (!studentId) {
            console.warn('‚ö†Ô∏è [CLIENT] - ID d\'√©l√®ve invalide');
            return;
        }
        setSelectedStudents(prev =>
            prev.includes(studentId)
                ? prev.filter(id => id !== studentId)
                : [...prev, studentId]
        );
    }, []);

    const handleStartSession = async () => {
        console.log('üöÄ [CLIENT] - Clic sur "D√©marrer la session". √âl√®ves s√©lectionn√©s:', selectedStudents);
        
        const onlineSelectedStudents = selectedStudents.filter(id => onlineStudents.includes(id));
        
        // Validation des s√©lections
        if (onlineSelectedStudents.length === 0) {
            toast({
                variant: 'destructive',
                title: 'Aucun √©l√®ve s√©lectionn√© en ligne',
                description: 'Veuillez s√©lectionner au moins un √©l√®ve actuellement en ligne pour d√©marrer la session.',
            });
            return;
        }

        // Validation du professeur
        if (!teacher.id) {
            toast({
                variant: 'destructive',
                title: 'Erreur d\'authentification',
                description: 'Identifiant professeur manquant.',
            });
            return;
        }

        setIsStartingSession(true);

        try {
            console.log('‚è≥ [CLIENT] - Appel de l\'action serveur `createCoursSession`...');
            const session = await createCoursSession(teacher.id, onlineSelectedStudents);
            
            if (!session?.id) {
                throw new Error('R√©ponse de session invalide');
            }

            console.log('‚úÖ [CLIENT] - Action serveur r√©ussie. Session cr√©√©e:', session);

            toast({
                title: 'Session cr√©√©e !',
                description: `Session vid√©o lanc√©e avec ${onlineSelectedStudents.length} √©l√®ve(s).`,
                duration: 3000,
            });

            // Redirection vers la session
            console.log(`üîÄ [CLIENT] - Redirection vers /session/${session.id}`);
            router.push(`/session/${session.id}`);

        } catch (error: unknown) {
            console.error('‚ùå [CLIENT] - Erreur lors de la cr√©ation de la session:', error);
            
            const errorMessage = error instanceof Error 
                ? error.message 
                : 'Une erreur inconnue est survenue';

            toast({
                variant: 'destructive',
                title: 'Erreur de cr√©ation de session',
                description: errorMessage,
                duration: 5000,
            });
        } finally {
            setIsStartingSession(false);
        }
    };

    // Tri s√©curis√© des √©l√®ves
    const sortedStudents = [...(classroom.eleves || [])].sort((a, b) => {
        const pointsA = a.points ?? 0;
        const pointsB = b.points ?? 0;
        return pointsB - pointsA;
    });

    // Fonction pour g√©n√©rer l'avatar de fa√ßon s√©curis√©e
    const getStudentAvatarUrl = (student: StudentForCard): string => {
        return `https://api.dicebear.com/7.x/pixel-art/svg?seed=${student.id || 'default'}`;
    };

    const getStudentInitial = (student: StudentForCard): string => {
        return student.name?.charAt(0)?.toUpperCase() || '?';
    };

    const onlineSelectedCount = selectedStudents.filter(id => onlineStudents.includes(id)).length;

    return (
        <main className="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-8 gap-4">
                <div className="flex items-center gap-4">
                    <BackButton />
                    <div>
                        <h1 className="text-3xl font-bold tracking-tight">
                            {classroom.nom || 'Classe sans nom'}
                        </h1>
                        <p className="text-muted-foreground">
                            G√©rez vos √©l√®ves, annonces et sessions pour cette classe.
                        </p>
                    </div>
                </div>
                <div className="flex gap-2">
                    <CreateAnnouncementForm classrooms={[classroom]} />
                    <AddStudentForm classroomId={classroom.id} />
                    
                    {/* Bouton de contr√¥le de simulation */}
                    <Button
                        variant={isSimulationMode ? "default" : "outline"}
                        size="sm"
                        onClick={() => setIsSimulationMode(!isSimulationMode)}
                        className="gap-2"
                    >
                        {isSimulationMode ? <Wifi className="h-4 w-4" /> : <WifiOff className="h-4 w-4" />}
                        {isSimulationMode ? 'Simulation' : 'R√©el'}
                    </Button>
                </div>
            </div>
            
            {/* Indicateur de mode */}
            {isSimulationMode && (
                <div className="mb-4 p-3 bg-yellow-100 border border-yellow-300 rounded-lg">
                    <div className="flex items-center gap-2 text-yellow-800">
                        <Wifi className="h-4 w-4" />
                        <span className="font-medium">Mode simulation activ√©</span>
                        <span className="text-sm">- Pr√©sence des √©l√®ves simul√©e pour le d√©veloppement</span>
                    </div>
                </div>
            )}
            
            {announcements && announcements.length > 0 && (
                <div className="mb-8">
                    <h2 className="text-2xl font-semibold tracking-tight mb-4">
                        Annonces de la classe ({announcements.length})
                    </h2>
                    <AnnouncementCarousel announcements={announcements} />
                </div>
            )}
            
            <Card>
                <CardHeader>
                    <CardTitle>
                        Liste des √âl√®ves ({classroom.eleves?.length || 0})
                        <span className="ml-2 text-sm font-normal text-green-600">
                            ‚Ä¢ {onlineStudents.length} en ligne
                        </span>
                    </CardTitle>
                    <CardDescription>
                        S√©lectionnez les √©l√®ves <span className="font-bold text-green-600">en ligne</span> (indicateur vert) pour d√©marrer une session vid√©o.
                    </CardDescription>
                </CardHeader>
                <CardContent>
                    {!classroom.eleves || classroom.eleves.length === 0 ? (
                        <div className="text-center py-8">
                            <p className="text-muted-foreground">
                                Aucun √©l√®ve dans cette classe pour le moment.
                            </p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            {sortedStudents.map((student, index) => {
                                const isOnline = onlineStudents.includes(student.id);
                                const isSelected = selectedStudents.includes(student.id);
                                
                                return (
                                    <Card 
                                        key={student.id} 
                                        className={cn(`transition-all duration-200`,
                                            isSelected 
                                                ? 'ring-2 ring-primary shadow-md' 
                                                : 'hover:shadow-sm',
                                            !isOnline && 'opacity-60 bg-muted/50'
                                        )}
                                    >
                                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                                            <CardTitle className="text-sm font-medium truncate max-w-[120px]">
                                                {student.name || '√âl√®ve sans nom'}
                                            </CardTitle>
                                            <div className="flex items-center gap-2">
                                                {isOnline ? (
                                                    <div className="h-2 w-2 rounded-full bg-green-500 animate-pulse" title="En ligne" />
                                                ) : (
                                                    <div className="h-2 w-2 rounded-full bg-gray-400" title="Hors ligne" />
                                                )}
                                                <Checkbox
                                                    checked={isSelected}
                                                    onCheckedChange={() => handleSelectStudent(student.id)}
                                                    disabled={isStartingSession || !isOnline}
                                                    aria-label={`S√©lectionner ${student.name}`}
                                                />
                                            </div>
                                        </CardHeader>
                                        <CardContent className="text-center">
                                            <div className="relative inline-block">
                                                <Avatar 
                                                    className="h-20 w-20 cursor-pointer" 
                                                    onClick={() => router.push(`/student/${student.id}?viewAs=teacher`)}
                                                >
                                                    <AvatarImage 
                                                        src={getStudentAvatarUrl(student)} 
                                                        alt={`Avatar de ${student.name}`}
                                                    />
                                                    <AvatarFallback>
                                                        {getStudentInitial(student)}
                                                    </AvatarFallback>
                                                </Avatar>
                                                {index === 0 && sortedStudents.length > 1 && (
                                                    <Crown className="absolute -top-2 -right-2 h-6 w-6 text-yellow-400 transform rotate-12" />
                                                )}
                                                {student.etat?.isPunished && (
                                                    <div className="absolute -bottom-1 -right-1 bg-destructive rounded-full p-1">
                                                        <XSquare className="h-4 w-4 text-destructive-foreground" />
                                                    </div>
                                                )}
                                            </div>
                                            <p className="text-xs text-muted-foreground mt-2 truncate">
                                                {student.email || 'Aucun email'}
                                            </p>
                                            <p className="text-xl font-bold mt-1">
                                                {student.points ?? 0} pts
                                            </p>
                                            <div className="mt-1 text-xs">
                                                {isOnline ? (
                                                    <span className="text-green-600 font-medium">‚óè En ligne</span>
                                                ) : (
                                                    <span className="text-gray-500">‚óè Hors ligne</span>
                                                )}
                                            </div>
                                        </CardContent>
                                    </Card>
                                );
                            })}
                        </div>
                    )}
                </CardContent>
                <CardFooter className="flex justify-between items-center">
                    <div className="text-sm text-muted-foreground">
                        {onlineSelectedCount > 0 
                            ? `${onlineSelectedCount} √©l√®ve(s) en ligne s√©lectionn√©(s)` 
                            : 'S√©lectionnez au moins un √©l√®ve en ligne'
                        }
                    </div>
                    <Button 
                        onClick={handleStartSession} 
                        disabled={onlineSelectedCount === 0 || isStartingSession}
                        className="min-w-[180px]"
                    >
                        {isStartingSession ? (
                            <>
                                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                Cr√©ation...
                            </>
                        ) : (
                            <>
                                <Video className="mr-2 h-4 w-4" />
                                D√©marrer la session ({onlineSelectedCount})
                            </>
                        )}
                    </Button>
                </CardFooter>
            </Card>
        </main>
    );
}
