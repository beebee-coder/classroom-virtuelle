import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/auth';

// Stockage en mÃ©moire temporaire (pour dÃ©veloppement)
const memoryStore = new Map();

const WHITEBOARD_SNAPSHOT_KEY = (sessionId: string) => `whiteboard:${sessionId}:snapshot`;

// POST handler for publishing whiteboard updates
export async function POST(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  const sessionId = params.id;
  const session = await auth();

  if (!session?.user) {
    return new NextResponse('Unauthorized', { status: 403 });
  }

  try {
    const body = await request.json();
    const { snapshot, senderSocketId } = body;

    if (!snapshot) {
      return new NextResponse('Snapshot data is required', { status: 400 });
    }
    
    // âœ… Stockage en mÃ©moire
    console.log(`ðŸ’¾ [SYNC POST] Stockage snapshot pour session ${sessionId}`);
    memoryStore.set(WHITEBOARD_SNAPSHOT_KEY(sessionId), snapshot);

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error(`ðŸ’¥ [API SYNC] - Erreur pour la session ${sessionId}:`, error);
    return new NextResponse('Internal Server Error', { status: 500 });
  }
}

// GET handler for retrieving the last known snapshot
export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  const sessionId = params.id;
  const session = await auth();

  if (!session?.user) {
    return new NextResponse('Unauthorized', { status: 403 });
  }
  
  try {
    // âœ… RÃ©cupÃ©ration depuis la mÃ©moire
    const snapshot = memoryStore.get(WHITEBOARD_SNAPSHOT_KEY(sessionId)) || null;
    console.log(`ðŸ’¾ [SYNC GET] RÃ©cupÃ©ration pour ${sessionId}:`, snapshot ? 'donnÃ©es trouvÃ©es' : 'aucune donnÃ©e');
    
    // âœ… IMPORTANT: Retourner directement le snapshot (pas d'objet wrapper)
    return NextResponse.json(snapshot);
  } catch (error) {
    console.error(`ðŸ’¥ [API SYNC GET] - Erreur pour la session ${sessionId}:`, error);
    return new NextResponse('Internal Server Error', { status: 500 });
  }
}