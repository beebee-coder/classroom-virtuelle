import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth-options";
import { ExcalidrawScene } from '@/types';

// Stockage en mÃ©moire temporaire (pour dÃ©veloppement)
const memoryStore = new Map<string, ExcalidrawScene>();

const WHITEBOARD_SCENE_KEY = (sessionId: string) => `whiteboard:${sessionId}:scene`;

// POST handler for publishing whiteboard updates
export async function POST(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  const sessionId = params.id;
  const session = await getServerSession(authOptions);

  if (!session?.user) {
    return new NextResponse('Unauthorized', { status: 403 });
  }

  try {
    const body = await request.json();
    const { sceneData } = body;

    if (!sceneData) {
      return new NextResponse('Scene data is required', { status: 400 });
    }
    
    // Stockage en mÃ©moire
    console.log(`ðŸ’¾ [SYNC POST] Stockage de la scÃ¨ne pour session ${sessionId}`);
    memoryStore.set(WHITEBOARD_SCENE_KEY(sessionId), sceneData);

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error(`ðŸ’¥ [API SYNC] - Erreur pour la session ${sessionId}:`, error);
    return new NextResponse('Internal Server Error', { status: 500 });
  }
}

// GET handler for retrieving the last known scene
export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  const sessionId = params.id;
  const session = await getServerSession(authOptions);

  if (!session?.user) {
    return new NextResponse('Unauthorized', { status: 403 });
  }
  
  try {
    // RÃ©cupÃ©ration depuis la mÃ©moire
    const scene = memoryStore.get(WHITEBOARD_SCENE_KEY(sessionId)) || null;
    console.log(`ðŸ’¾ [SYNC GET] RÃ©cupÃ©ration pour ${sessionId}:`, scene ? 'donnÃ©es trouvÃ©es' : 'aucune donnÃ©e');
    
    return NextResponse.json(scene);
  } catch (error) {
    console.error(`ðŸ’¥ [API SYNC GET] - Erreur pour la session ${sessionId}:`, error);
    return new NextResponse('Internal Server Error', { status: 500 });
  }
}
