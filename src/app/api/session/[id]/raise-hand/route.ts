// src/app/api/session/[id]/raise-hand/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { updateStudentSessionStatus } from '@/lib/actions/session.actions';

export async function POST(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  const sessionId = params.id;
  console.log(`‚úã [API RAISE-HAND] - Requ√™te re√ßue pour la session ${sessionId}`);
  try {
    const body = await request.json();
    const { userId, isRaised } = body;
    console.log(`  Payload: userId=${userId}, isRaised=${isRaised}`);

    if (userId === undefined || isRaised === undefined) {
      console.error('‚ùå [API RAISE-HAND] - Param√®tres manquants: userId et isRaised sont requis.');
      return new NextResponse('userId and isRaised are required', { status: 400 });
    }
    
    const { pusherTrigger } = await import('@/lib/pusher/server');
    const channel = `presence-session-${sessionId}`;
    console.log(`  D√©clenchement de l'√©v√©nement 'hand-raise-update' sur le canal ${channel}`);
    await pusherTrigger(channel, 'hand-raise-update', { userId, isRaised });

    console.log('‚úÖ [API RAISE-HAND] - √âv√©nement diffus√© avec succ√®s.');
    return NextResponse.json({ success: true });
  } catch (error) {
    console.error(`üí• [API RAISE-HAND] - Erreur interne pour la session ${sessionId}:`, error);
    return new NextResponse('Internal Server Error', { status: 500 });
  }
}
