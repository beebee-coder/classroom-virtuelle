// src/app/api/pusher/send-invitation/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { pusherTrigger } from '@/lib/pusher/server';

export async function POST(request: NextRequest) {
    try {
        const body = await request.json();
        const { channel, event, data } = body;

        console.log('üì® [API INVITATION] - Requ√™te re√ßue:', { channel, event, data });

        // Validation des param√®tres
        if (!channel || !event || !data) {
            return NextResponse.json(
                { error: 'Param√®tres manquants: channel, event et data sont requis' },
                { status: 400 }
            );
        }

        // V√©rifier que le canal est un canal priv√© utilisateur
        if (!channel.startsWith('private-user-')) {
            return NextResponse.json(
                { error: 'Canal non autoris√©. Seuls les canaux priv√©s utilisateur sont autoris√©s' },
                { status: 403 }
            );
        }

        console.log('üöÄ [API INVITATION] - Envoi via Pusher...');
        
        // Envoyer l'√©v√©nement via Pusher
        const result = await pusherTrigger(channel, event, data);

        console.log('‚úÖ [API INVITATION] - Invitation envoy√©e avec succ√®s:', {
            channel,
            event,
            studentId: channel.replace('private-user-', ''),
            sessionId: data.sessionId
        });

        return NextResponse.json({ 
            success: true, 
            message: 'Invitation envoy√©e',
            channel,
            event,
            studentId: channel.replace('private-user-', '')
        });

    } catch (error) {
        console.error('‚ùå [API INVITATION] - Erreur:', error);
        return NextResponse.json(
            { 
                error: 'Erreur lors de l\'envoi de l\'invitation',
                details: error instanceof Error ? error.message : 'Erreur inconnue'
            },
            { status: 500 }
        );
    }
}