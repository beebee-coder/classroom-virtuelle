import { PrismaClient, Role, TaskType, TaskCategory, TaskDifficulty, ValidationType } from '@prisma/client';
import * as dotenv from 'dotenv';

dotenv.config({ path: '.env.local' });

const prisma = new PrismaClient();

async function main() {
  console.log('üå± Start seeding...');

  // Nettoyer la base de donn√©es d'abord (optionnel - pour un environnement de d√©veloppement)
  console.log('üßπ Cleaning database...');
  await prisma.etatEleve.deleteMany();
  await prisma.user.deleteMany();
  await prisma.announcement.deleteMany();
  await prisma.task.deleteMany();
  await prisma.metier.deleteMany();
  await prisma.classroom.deleteMany();

  // Utiliser upsert pour rendre le script idempotent
  const teacher = await prisma.user.upsert({
    where: { email: 'teacher@example.com' },
    update: {},
    create: {
      email: 'teacher@example.com',
      name: 'Professeur Test',
      role: 'PROFESSEUR' as Role,
    },
  });
  console.log(`üë®‚Äçüè´ Ensured teacher exists: ${teacher.name} (${teacher.email})`);

  // Cr√©er des classes avec une cl√© unique correcte
  const classA = await prisma.classroom.upsert({
    where: { 
      id: 'classe-6eme-a'
    },
    update: {},
    create: {
      id: 'classe-6eme-a',
      nom: 'Classe 6√®me A',
      professeurId: teacher.id,
    },
  });
  console.log(`üè´ Ensured class exists: ${classA.nom}`);

  const classB = await prisma.classroom.upsert({
    where: { 
      id: 'classe-6eme-b'
    },
    update: {},
    create: {
      id: 'classe-6eme-b',
      nom: 'Classe 6√®me B',
      professeurId: teacher.id,
    },
  });
  console.log(`üè´ Ensured class exists: ${classB.nom}`);

  const classC = await prisma.classroom.upsert({
    where: { 
      id: 'classe-5eme-a'
    },
    update: {},
    create: {
      id: 'classe-5eme-a',
      nom: 'Classe 5√®me A',
      professeurId: teacher.id,
    },
  });
  console.log(`üè´ Ensured class exists: ${classC.nom}`);

  // Cr√©er des √©l√®ves
  const students = [
    // Classe A
    { name: 'Ahmed', classeId: classA.id, ambition: 'Devenir Astronaute' },
    { name: 'Bilel', classeId: classA.id, ambition: 'Explorer les fonds marins' },
    { name: 'Fatima', classeId: classA.id, ambition: 'Cr√©er des jeux vid√©o' },
    { name: 'Khadija', classeId: classA.id, ambition: 'Devenir chef cuisinier' },
    { name: 'Youssef', classeId: classA.id, ambition: '√ätre un grand artiste' },
    { name: 'Amina', classeId: classA.id, ambition: 'Prot√©ger la nature' },
    { name: 'Omar', classeId: classA.id, ambition: 'Construire des robots' },
    { name: 'Leila', classeId: classA.id, ambition: 'Soigner les animaux' },
    { name: 'Ibrahim', classeId: classA.id, ambition: 'Devenir pompier' },
    { name: 'Nora', classeId: classA.id, ambition: 'Voyager dans le temps' },
    // Classe B
    { name: 'Ali', classeId: classB.id, ambition: 'Piloter des avions' },
    { name: 'Sofia', classeId: classB.id, ambition: '√âcrire des histoires' },
    { name: 'Mehdi', classeId: classB.id, ambition: 'Devenir un champion de sport' },
    { name: 'Yasmina', classeId: classB.id, ambition: 'Inventer de nouvelles choses' },
    { name: 'Karim', classeId: classB.id, ambition: '√ätre d√©tective' },
    { name: 'Sara', classeId: classB.id, ambition: 'Gu√©rir les maladies' },
    { name: 'Hassan', classeId: classB.id, ambition: 'Explorer des grottes' },
    { name: 'Ines', classeId: classB.id, ambition: 'Parler toutes les langues' },
    { name: 'Rachid', classeId: classB.id, ambition: 'Construire des ponts' },
    { name: 'Samira', classeId: classB.id, ambition: 'Chanter sur sc√®ne' },
    // Classe C
    { name: 'Zayd', classeId: classC.id, ambition: 'D√©couvrir des tr√©sors' },
    { name: 'Lina', classeId: classC.id, ambition: 'Dessiner des mangas' },
    { name: 'Adil', classeId: classC.id, ambition: 'Cr√©er des applications' },
    { name: 'Dounia', classeId: classC.id, ambition: 'Devenir photographe' },
    { name: 'Anis', classeId: classC.id, ambition: 'Comprendre les √©toiles' },
    { name: 'Nadia', classeId: classC.id, ambition: 'Faire le tour du monde' },
    { name: 'Ismail', classeId: classC.id, ambition: 'Construire des cabanes' },
    { name: 'Rania', classeId: classC.id, ambition: 'Aider les autres' },
    { name: 'Malik', classeId: classC.id, ambition: '√ätre un super-h√©ros' },
    { name: 'Zahra', classeId: classC.id, ambition: 'Cultiver un jardin magique' },
  ];

  for (const [index, studentData] of students.entries()) {
    const email = studentData.name === 'Ahmed' 
      ? 'ahmed0@example.com' 
      : `${studentData.name.toLowerCase()}${index}@example.com`;
      
    const student = await prisma.user.upsert({
      where: { email: email },
      update: {
        name: studentData.name,
        classeId: studentData.classeId,
        ambition: studentData.ambition,
      },
      create: {
        email: email,
        name: studentData.name,
        role: 'ELEVE' as Role,
        classeId: studentData.classeId,
        ambition: studentData.ambition,
      },
    });

    // Assurer que l'√©tat de l'√©l√®ve existe aussi
    await prisma.etatEleve.upsert({
        where: { eleveId: student.id },
        update: {},
        create: { eleveId: student.id },
    });
    console.log(`üéì Ensured student exists: ${student.name}`);
  }

  // Cr√©er des m√©tiers - utiliser le nom comme cl√© unique (puisque c'est unique dans le sch√©ma)
  const metiers = [
    { 
      id: 'metier-pompier',
      nom: 'Pompier', 
      description: 'Sauve des vies et combat le feu.', 
      icon: 'Flame', 
      theme: { 
        backgroundColor: 'from-red-500 to-orange-500', 
        textColor: 'text-white', 
        primaryColor: '22 84% 44%', 
        accentColor: '45 93% 47%', 
        cursor: 'cursor-crosshair' 
      } 
    },
    { 
      id: 'metier-astronaute',
      nom: 'Astronaute', 
      description: 'Explore l\'espace et les √©toiles.', 
      icon: 'Rocket', 
      theme: { 
        backgroundColor: 'from-blue-800 to-indigo-900', 
        textColor: 'text-white', 
        primaryColor: '217 91% 60%', 
        accentColor: '262 84% 60%', 
        cursor: 'cursor-pointer' 
      } 
    },
    { 
      id: 'metier-veterinaire',
      nom: 'V√©t√©rinaire', 
      description: 'Soigne les animaux.', 
      icon: 'Stethoscope', 
      theme: { 
        backgroundColor: 'from-green-400 to-teal-500', 
        textColor: 'text-white', 
        primaryColor: '142 76% 36%', 
        accentColor: '160 84% 39%', 
        cursor: 'cursor-help' 
      } 
    },
    { 
      id: 'metier-devjeux',
      nom: 'DevJeux', 
      description: 'Cr√©e des mondes virtuels.', 
      icon: 'Gamepad2', 
      theme: { 
        backgroundColor: 'from-purple-600 to-blue-600', 
        textColor: 'text-white', 
        primaryColor: '250 84% 60%', 
        accentColor: '280 84% 60%', 
        cursor: 'cursor-grab' 
      } 
    },
    { 
      id: 'metier-chef',
      nom: 'Chef', 
      description: 'Invente des plats d√©licieux.', 
      icon: 'ChefHat', 
      theme: { 
        backgroundColor: 'from-yellow-400 to-amber-500', 
        textColor: 'text-black', 
        primaryColor: '38 92% 50%', 
        accentColor: '24 98% 52%', 
        cursor: 'cursor-cell' 
      } 
    },
    { 
      id: 'metier-artiste',
      nom: 'Artiste', 
      description: 'Exprime sa cr√©ativit√©.', 
      icon: 'Paintbrush', 
      theme: { 
        backgroundColor: 'from-pink-500 to-rose-500', 
        textColor: 'text-white', 
        primaryColor: '320 84% 60%', 
        accentColor: '340 84% 60%', 
        cursor: 'cursor-alias' 
      } 
    },
    { 
      id: 'metier-ecologiste',
      nom: '√âcologiste', 
      description: 'Prot√®ge la plan√®te.', 
      icon: 'Leaf', 
      theme: { 
        backgroundColor: 'from-lime-500 to-emerald-600', 
        textColor: 'text-white', 
        primaryColor: '120 73% 40%', 
        accentColor: '140 73% 40%', 
        cursor: 'cursor-zoom-in' 
      } 
    },
  ];
  
  for (const metier of metiers) {
    await prisma.metier.upsert({
      where: { id: metier.id },
      update: {
        nom: metier.nom,
        description: metier.description,
        icon: metier.icon,
        theme: JSON.stringify(metier.theme),
      },
      create: {
        id: metier.id,
        nom: metier.nom,
        description: metier.description,
        icon: metier.icon,
        theme: JSON.stringify(metier.theme),
      }
    });
    console.log(`üõ†Ô∏è Ensured metier exists: ${metier.nom}`);
  }

  // Cr√©er des t√¢ches avec des IDs explicites
  const tasks = [
    // T√¢ches quotidiennes
    { 
      id: 'task-daily-bed',
      title: 'Faire son lit', 
      description: 'Un lit bien fait, une journ√©e bien commenc√©e !', 
      points: 10, 
      type: TaskType.DAILY, 
      category: TaskCategory.HOME, 
      difficulty: TaskDifficulty.EASY, 
      validationType: ValidationType.PARENT 
    },
    { 
      id: 'task-daily-reading',
      title: 'Lire 15 minutes', 
      description: 'Un chapitre par jour pour voyager.', 
      points: 15, 
      type: TaskType.DAILY, 
      category: TaskCategory.LANGUAGE, 
      difficulty: TaskDifficulty.EASY, 
      validationType: ValidationType.PARENT 
    },
    // T√¢ches hebdomadaires
    { 
      id: 'task-weekly-clean',
      title: 'Ranger sa chambre', 
      description: 'Un espace propre pour des id√©es claires.', 
      points: 50, 
      type: TaskType.WEEKLY, 
      category: TaskCategory.HOME, 
      difficulty: TaskDifficulty.MEDIUM, 
      validationType: ValidationType.PARENT, 
      requiresProof: true 
    },
    { 
      id: 'task-weekly-math',
      title: 'Exercice de maths', 
      description: 'R√©soudre une s√©rie de probl√®mes complexes.', 
      points: 70, 
      type: TaskType.WEEKLY, 
      category: TaskCategory.MATH, 
      difficulty: TaskDifficulty.MEDIUM, 
      validationType: ValidationType.PROFESSOR, 
      requiresProof: true 
    },
    // T√¢ches mensuelles
    { 
      id: 'task-monthly-creative',
      title: 'Projet cr√©atif mensuel', 
      description: 'R√©aliser une recette de cuisine et la pr√©senter.', 
      points: 200, 
      type: TaskType.MONTHLY, 
      category: TaskCategory.ART, 
      difficulty: TaskDifficulty.HARD, 
      validationType: ValidationType.PARENT, 
      requiresProof: true 
    },
    { 
      id: 'task-monthly-science',
      title: 'Expos√© scientifique', 
      description: 'Pr√©parer et pr√©senter un sujet scientifique.', 
      points: 250, 
      type: TaskType.MONTHLY, 
      category: TaskCategory.SCIENCE, 
      difficulty: TaskDifficulty.HARD, 
      validationType: ValidationType.PROFESSOR, 
      requiresProof: true 
    },
  ];

  for (const task of tasks) {
    await prisma.task.upsert({
        where: { id: task.id },
        update: task,
        create: task,
    });
    console.log(`üìù Ensured task exists: ${task.title}`);
  }

  // Cr√©er des annonces avec des IDs explicites
  await prisma.announcement.upsert({
    where: { id: 'announcement-welcome' },
    update: {},
    create: {
      id: 'announcement-welcome',
      title: 'Bienvenue sur Classroom Connector !',
      content: 'C\'est la plateforme o√π l\'apprentissage devient une aventure. Participez, gagnez des points et explorez votre avenir !',
      authorId: teacher.id,
      // Annonce publique (pas de classeId)
    }
  });
  
  await prisma.announcement.upsert({
    where: { id: 'announcement-reminder-6a' },
    update: {},
    create: {
      id: 'announcement-reminder-6a',
      title: 'Rappel pour la 6√®me A',
      content: 'N\'oubliez pas de pr√©parer vos questions pour la session de demain sur les volcans.',
      authorId: teacher.id,
      classeId: classA.id,
    }
  });
   
  console.log('üì¢ Ensured default announcements exist');

  console.log('‚úÖ Seeding finished.');
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });