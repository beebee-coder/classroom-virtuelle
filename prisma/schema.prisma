// prisma/schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// MODÈLES DE BASE
model User {
  id               String            @id @default(cuid())
  name             String?
  email            String?           @unique
  emailVerified    DateTime?
  image            String?
  password         String?
  parentPassword   String? // Mot de passe pour l'espace de validation parental
  role             Role              @default(ELEVE)
  points           Int               @default(0)
  ambition         String?
  validationStatus ValidationStatus  @default(PENDING)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  
  // Relations
  classeId         String?
  classe           Classroom?        @relation(fields: [classeId], references: [id], onDelete: SetNull)
  announcements    Announcement[]    @relation("UserAnnouncements")
  createdTasks     Task[]            @relation("CreatedTasks")
  studentProgress  StudentProgress[]
  etat             EtatEleve?
  messages         Message[]
  reactions        Reaction[]
  sessions         CoursSession[]    @relation("SessionParticipants") // Relation plusieurs-à-plusieurs
  ownedSessions    CoursSession[]    @relation("SessionOwner")
  createdQuizzes   Quiz[]
  quizResponses    QuizResponse[]
}

model Classroom {
  id           String         @id @default(cuid())
  nom          String
  professeurId String
  professeur   User           @relation(fields: [professeurId], references: [id], onDelete: Cascade)
  eleves       User[]
  announcements Announcement[]
  sessions     CoursSession[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model EtatEleve {
  id         String   @id @default(cuid())
  eleveId    String   @unique
  eleve      User     @relation(fields: [eleveId], references: [id], onDelete: Cascade)
  metierId   String?
  metier     Metier?  @relation(fields: [metierId], references: [id], onDelete: SetNull)
  isPunished Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Metier {
  id          String      @id @default(cuid())
  nom         String      @unique
  description String
  icon        String?
  theme       Json?
  etatsEleves EtatEleve[]
}

// MODÈLES DE GAMIFICATION
model Task {
  id              String            @id @default(cuid())
  title           String
  description     String
  points          Int
  type            TaskType          @default(DAILY)
  category        TaskCategory      @default(OTHER)
  difficulty      TaskDifficulty    @default(EASY)
  validationType  ValidationType    @default(AUTOMATIC)
  requiresProof   Boolean           @default(false)
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  createdById     String?           // Colonne ajoutée
  createdBy       User?             @relation("CreatedTasks", fields: [createdById], references: [id], onDelete: SetNull)

  studentProgress StudentProgress[]
}

model StudentProgress {
  id              String          @id @default(cuid())
  studentId       String
  student         User            @relation(fields: [studentId], references: [id], onDelete: Cascade)
  taskId          String
  task            Task            @relation(fields: [taskId], references: [id], onDelete: Cascade)
  status          ProgressStatus  @default(PENDING_VALIDATION)
  completionDate  DateTime        @default(now())
  pointsAwarded   Int?
  submissionUrl   String?
  feedback        Json?           @default("null")
  recipeName      String?
  
  @@unique([studentId, taskId, completionDate])
}

// MODÈLES DE SESSION
model CoursSession {
  id            String    @id @default(cuid())
  professeurId  String
  professeur    User      @relation("SessionOwner", fields: [professeurId], references: [id], onDelete: Cascade)
  classroomId   String
  classe        Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  startTime     DateTime  @default(now())
  endTime       DateTime?
  activeQuizId  String?
  activeQuiz    Quiz?      @relation(fields: [activeQuizId], references: [id], onDelete: SetNull)
  
  participants  User[]     @relation("SessionParticipants") // Relation plusieurs-à-plusieurs
  
  @@index([startTime, endTime])
}

model SharedDocument {
  id        String   @id @default(cuid())
  name      String
  url       String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

// MODÈLES DE COMMUNICATION
model Announcement {
  id            String     @id @default(cuid())
  title         String
  content       String
  authorId      String
  author        User       @relation("UserAnnouncements", fields: [authorId], references: [id])
  classeId      String?
  classe        Classroom? @relation(fields: [classeId], references: [id], onDelete: SetNull)
  attachmentUrl String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt // Colonne ajoutée
}

model Message {
  id          String   @id @default(cuid())
  message     String
  classroomId String
  classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  senderId    String
  sender      User      @relation(fields: [senderId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  
  reactions Reaction[]
}

model Reaction {
  id        String  @id @default(cuid())
  emoji     String
  messageId String
  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([messageId, userId, emoji])
}

// MODÈLES DE QUIZ
model Quiz {
  id              String         @id @default(cuid())
  title           String
  createdAt       DateTime       @default(now())
  createdById     String
  createdBy       User           @relation(fields: [createdById], references: [id])
  questions       QuizQuestion[]
  responses       QuizResponse[]
  activeInSession CoursSession[]
  awardedPointsAt DateTime? // Pour l'idempotence
}

model QuizQuestion {
  id              String       @id @default(cuid())
  quizId          String
  quiz            Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  text            String
  options         QuizOption[]
  correctOptionId String
}

model QuizOption {
  id         String       @id @default(cuid())
  questionId String
  question   QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  text       String
}

model QuizResponse {
  id               String   @id @default(cuid())
  quizId           String
  quiz             Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  answers          Json // { "questionId": "selectedOptionId" }
  answerTimestamps Json?
  submittedAt      DateTime @default(now())

  @@unique([quizId, userId])
}


// ENUMS
enum Role {
  PROFESSEUR
  ELEVE
}

enum ValidationStatus {
  PENDING
  VALIDATED
  REJECTED
}

enum TaskType {
  DAILY
  WEEKLY
  MONTHLY
}

enum TaskCategory {
  HOME
  SCHOOL
  SOCIAL
  SPORT
  ART
  MUSIC
  LANGUAGE
  MATH
  SCIENCE
  OTHER
}

enum TaskDifficulty {
  EASY
  MEDIUM
  HARD
}

enum ValidationType {
  AUTOMATIC
  PROFESSOR
  PARENT
}

enum ProgressStatus {
  PENDING_VALIDATION
  VERIFIED
  REJECTED
}
